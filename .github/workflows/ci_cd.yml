name: MLOps Production Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  ARTIFACT_REPO: mlops-docker-repo
  IMAGE_NAME: gemini-mlops

jobs:
  # 1. Continuous Integration: Quality Checks
  test:
    name: Run Tests & Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run Pipeline Tests (Mock Mode)
        env:
          USE_MOCK: "true"
          GEMINI_API_KEY: "mock-key" # Mock mode doesn't need real key
        run: |
          # Create a dummy test file if one doesn't exist for pytest logic
          # In a real scenario, this runs your actual unit tests
          python test_pipeline.py

  # 2. Continuous Delivery: Infrastructure & Containerization
  deploy:
    name: Build & Deploy
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' # Only deploy on main branch
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Setup Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Authenticate to Google Cloud (Requires Secrets)
      # - name: Google Auth
      #   uses: google-github-actions/auth@v2
      #   with:
      #     credentials_json: ${{ secrets.GCP_SA_KEY }}

      # Build Docker Image
      - name: Build Docker Image
        run: |
          docker build -t $IMAGE_NAME .

      # Push to Artifact Registry (Commented until secrets are set)
      # - name: Push to Artifact Registry
      #   run: |
      #     gcloud auth configure-docker $REGION-docker.pkg.dev
      #     docker tag $IMAGE_NAME $REGION-docker.pkg.dev/$PROJECT_ID/$ARTIFACT_REPO/$IMAGE_NAME:latest
      #     docker push $REGION-docker.pkg.dev/$PROJECT_ID/$ARTIFACT_REPO/$IMAGE_NAME:latest

      # Run Terraform (Commented until secrets are set)
      # - name: Setup Terraform
      #   uses: hashicorp/setup-terraform@v3
      # - name: Terraform Init & Apply
      #   run: |
      #     cd terraform
      #     terraform init
      #     terraform apply -auto-approve
      #   env:
      #     GOOGLE_CREDENTIALS: ${{ secrets.GCP_SA_KEY }}
